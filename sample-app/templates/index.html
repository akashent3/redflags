<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RedFlag AI Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="container mx-auto px-4 py-8">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">RedFlag AI Analyzer</h1>
        <p class="text-gray-600">Upload 3 years of Annual Reports for forensic analysis</p>
    </header>

    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <form id="uploadForm" class="flex flex-col gap-4">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="dropZone">
                <input type="file" id="fileInput" name="files" multiple accept=".pdf" class="hidden">
                <label for="fileInput" class="cursor-pointer text-blue-600 font-medium hover:text-blue-800">
                    Click to upload
                </label>
                <span class="text-gray-500"> or drag and drop Annual Reports (PDF)</span>
                <div id="fileList" class="mt-4 text-sm text-gray-600"></div>
            </div>
            <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition w-full md:w-auto self-end disabled:opacity-50">
                Run Analysis
            </button>
        </form>
    </div>

    <div id="loader" class="hidden text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-600">Gemini is analyzing reports and checking all 54 flags...</p>
    </div>

    <div id="results" class="hidden">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h3 class="text-gray-500 text-sm font-semibold uppercase">Overall Risk Score</h3>
                <div class="text-5xl font-bold mt-2" id="scoreValue">--</div>
                <div class="text-lg font-medium mt-1" id="riskLevel">--</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md col-span-2">
                <h3 class="text-gray-500 text-sm font-semibold uppercase mb-2">Executive Summary</h3>
                <p class="text-gray-700 text-sm leading-relaxed" id="summaryText">--</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-gray-800 font-bold mb-4">Category Breakdown</h3>
            <div class="h-64">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                <h3 class="text-gray-800 font-bold">Detailed Flag Analysis (54 Flags)</h3>
                <span class="text-xs text-gray-500">Sorted by: Triggered First</span>
            </div>
            <div id="flagsContainer" class="divide-y divide-gray-200">
                </div>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    
    // File selection UI
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        fileList.innerHTML = files.map(f => `<div class="text-gray-700">ðŸ“„ ${f.name}</div>`).join('');
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const files = fileInput.files;
        if(files.length === 0) return alert("Please select files first.");

        // Show loader
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');
        form.querySelector('button').disabled = true;

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        try {
            const res = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if(res.ok) {
                renderResults(data);
            } else {
                alert("Error: " + data.error);
            }
        } catch (err) {
            console.error(err);
            alert("Analysis failed.");
        } finally {
            document.getElementById('loader').classList.add('hidden');
            form.querySelector('button').disabled = false;
        }
    });

    function renderResults(data) {
        document.getElementById('results').classList.remove('hidden');
        
        // Score
        const scoreEl = document.getElementById('scoreValue');
        scoreEl.textContent = data.risk_score;
        scoreEl.className = `text-5xl font-bold mt-2 ${getColor(data.risk_score)}`;
        
        document.getElementById('riskLevel').textContent = data.risk_level;
        document.getElementById('summaryText').textContent = data.summary;

        // Chart
        const ctx = document.getElementById('categoryChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(data.category_scores),
                datasets: [{
                    label: 'Risk Score (0-100)',
                    data: Object.values(data.category_scores),
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });

        // Flags List - Render ALL flags
        const container = document.getElementById('flagsContainer');
        
        // Sorting: Triggered flags first, then by flag number
        const sortedFlags = data.flags.sort((a, b) => {
            if (a.is_triggered === b.is_triggered) return a.flag_number - b.flag_number;
            return a.is_triggered ? -1 : 1;
        });

        container.innerHTML = sortedFlags.map(flag => {
            const isTriggered = flag.is_triggered;
            
            // Dynamic styling
            const cardBg = isTriggered ? 'bg-white' : 'bg-gray-50 opacity-75';
            
            // Badge styling
            let badgeClass = 'bg-green-100 text-green-800';
            let severityLabel = 'PASSED';
            
            if (isTriggered) {
                severityLabel = flag.severity;
                if(flag.severity === 'CRITICAL') badgeClass = 'bg-red-100 text-red-800';
                else if(flag.severity === 'HIGH') badgeClass = 'bg-orange-100 text-orange-800';
                else badgeClass = 'bg-yellow-100 text-yellow-800';
            }

            // Evidence box styling
            const evidenceBg = isTriggered ? 'bg-red-50 text-gray-800 border-red-100' : 'bg-white text-gray-500 border-gray-200';

            return `
            <div class="p-6 border-b border-gray-100 hover:bg-gray-50 transition ${cardBg}">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${badgeClass}">
                            ${severityLabel}
                        </span>
                        <span class="ml-2 text-xs text-gray-500 tracking-wide uppercase">${flag.category}</span>
                    </div>
                    <span class="text-sm font-medium text-gray-400">Confidence: ${flag.confidence_score || 0}%</span>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-gray-400 font-mono text-sm">#${flag.flag_number}</span>
                    <h4 class="text-lg font-bold ${isTriggered ? 'text-gray-900' : 'text-gray-500'}">${flag.flag_name}</h4>
                </div>
                <p class="text-sm p-3 rounded border italic ${evidenceBg}">
                    "${flag.evidence || 'No issues found.'}"
                </p>
            </div>
            `;
        }).join('');
    }

    function getColor(score) {
        if(score < 20) return 'text-green-600';
        if(score < 40) return 'text-blue-600';
        if(score < 60) return 'text-yellow-600';
        if(score < 80) return 'text-orange-600';
        return 'text-red-600';
    }
</script>

</body>
</html>