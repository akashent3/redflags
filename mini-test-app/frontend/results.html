<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - Gemini Pipeline Test</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>üìä Analysis Results</h1>
            <p class="subtitle">Gemini 2.5 Flash Pipeline - Red Flag Detection</p>
        </header>

        <div class="results-container">
            <!-- Results Header -->
            <div class="results-header">
                <div>
                    <h2 id="companyName">Loading...</h2>
                    <p id="analysisDate"></p>
                </div>
                <button id="downloadBtn" class="download-btn">üì• Download JSON</button>
            </div>

            <!-- Risk Score Gauge -->
            <div class="risk-gauge">
                <h3>Overall Risk Score</h3>
                <div id="riskScore" class="gauge-value">--</div>
                <div id="riskLevel" style="font-size: 1.5rem; margin-top: 10px;">--</div>
                <p style="margin-top: 10px; color: #666;">
                    <span id="flagsTriggered">0</span> / 54 Red Flags Triggered
                </p>
            </div>

            <!-- Category Scores -->
            <h3 style="margin-top: 40px; margin-bottom: 20px;">Category Breakdown</h3>
            <div class="category-scores" id="categoryScores">
                <!-- Dynamically populated -->
            </div>

            <!-- Red Flags List -->
            <div class="flags-section">
                <h3>Red Flags Summary</h3>
                <div style="margin: 20px 0;">
                    <button class="filter-btn active" data-filter="all">All (54)</button>
                    <button class="filter-btn" data-filter="triggered">Triggered Only</button>
                    <button class="filter-btn" data-filter="critical">Critical</button>
                    <button class="filter-btn" data-filter="high">High</button>
                </div>
                <div id="flagsList">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <footer>
            <p><a href="/" style="color: white;">‚Üê Upload New Analysis</a></p>
        </footer>
    </div>

    <script>
        // Get job ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('job_id');

        if (!jobId) {
            alert('No job ID provided');
            window.location.href = '/';
        }

        // Load results
        loadResults(jobId);

        async function loadResults(jobId) {
            try {
                const response = await fetch(`/api/results/${jobId}`);
                if (!response.ok) throw new Error('Failed to load results');

                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error('Error loading results:', error);
                alert('Failed to load results: ' + error.message);
            }
        }

        function displayResults(data) {
            // Company info
            document.getElementById('companyName').textContent = data.company.name;
            document.getElementById('analysisDate').textContent =
                'Analyzed on ' + new Date(data.company.analysis_date).toLocaleString();

            // Risk score
            const riskScore = data.analysis_result.risk_score;
            const riskLevel = data.analysis_result.risk_level;

            document.getElementById('riskScore').textContent = riskScore;
            document.getElementById('riskScore').className =
                'gauge-value ' + riskLevel.toLowerCase();
            document.getElementById('riskLevel').textContent = riskLevel;
            document.getElementById('flagsTriggered').textContent =
                data.analysis_result.flags_triggered_count;

            // Category scores
            const categoryScores = document.getElementById('categoryScores');
            const categories = [
                { key: 'auditor', name: 'Auditor' },
                { key: 'cash_flow', name: 'Cash Flow' },
                { key: 'related_party', name: 'Related Party' },
                { key: 'promoter', name: 'Promoter' },
                { key: 'governance', name: 'Governance' },
                { key: 'balance_sheet', name: 'Balance Sheet' },
                { key: 'revenue', name: 'Revenue' },
                { key: 'textual', name: 'Textual' }
            ];

            categories.forEach(cat => {
                const score = data.analysis_result.category_scores[cat.key] || 0;
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `
                    <h4>${cat.name}</h4>
                    <div class="score">${score}</div>
                    <div style="color: #666; font-size: 0.9rem;">/ 100</div>
                `;
                categoryScores.appendChild(card);
            });

            // Red flags
            const flagsList = document.getElementById('flagsList');
            data.red_flags.forEach(flag => {
                const card = document.createElement('div');
                card.className = 'flag-card' + (flag.is_triggered ? ' triggered' : '');
                card.dataset.category = flag.category;
                card.dataset.severity = flag.severity.toLowerCase();
                card.dataset.triggered = flag.is_triggered;

                card.innerHTML = `
                    <div class="flag-header">
                        <div>
                            <span class="flag-number">#${flag.flag_number}</span>
                            <strong>${flag.flag_name}</strong>
                        </div>
                        <div>
                            <span class="severity-badge severity-${flag.severity.toLowerCase()}">
                                ${flag.severity}
                            </span>
                            ${flag.is_triggered ? '<span style="margin-left: 10px;">‚ö†Ô∏è TRIGGERED</span>' : '<span style="margin-left: 10px;">‚úÖ OK</span>'}
                        </div>
                    </div>
                    ${flag.is_triggered ? `
                        <div style="margin-top: 12px;">
                            <strong>Evidence:</strong>
                            <p style="color: #666; margin-top: 6px;">${flag.evidence_text}</p>
                            <p style="margin-top: 6px; font-size: 0.9rem; color: #888;">
                                Confidence: ${flag.confidence_score}%
                                ${flag.page_references.length > 0 ? ` | Pages: ${flag.page_references.join(', ')}` : ''}
                            </p>
                        </div>
                    ` : ''}
                `;
                flagsList.appendChild(card);
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const filter = this.dataset.filter;
                    document.querySelectorAll('.flag-card').forEach(card => {
                        let show = true;

                        if (filter === 'triggered') {
                            show = card.dataset.triggered === 'true';
                        } else if (filter === 'critical' || filter === 'high') {
                            show = card.dataset.severity === filter;
                        }

                        card.style.display = show ? 'block' : 'none';
                    });
                });
            });

            // Download button
            document.getElementById('downloadBtn').addEventListener('click', function () {
                window.location.href = `/api/download/${jobId}`;
            });
        }
    </script>

    <style>
        .filter-btn {
            padding: 8px 16px;
            margin-right: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #f8f9ff;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }
    </style>
</body>

</html>