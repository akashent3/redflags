<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RedFlag AI - Test Pipeline</title>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface2: #242833;
            --border: #2d3140;
            --text: #e1e4eb;
            --text-dim: #8b8fa3;
            --red: #ef4444;
            --orange: #f97316;
            --amber: #f59e0b;
            --blue: #3b82f6;
            --green: #22c55e;
            --purple: #a855f7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        h1 span { color: var(--red); }
        .subtitle { color: var(--text-dim); font-size: 14px; margin-bottom: 30px; }

        /* Upload Section */
        .upload-card { background: var(--surface); border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; margin-bottom: 30px; transition: border-color 0.2s; }
        .upload-card:hover { border-color: var(--blue); }
        .upload-card.dragging { border-color: var(--blue); background: rgba(59, 130, 246, 0.05); }
        .upload-card input[type="file"] { display: none; }
        .upload-btn { background: var(--blue); color: white; border: none; padding: 12px 28px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; }
        .upload-btn:hover { background: #2563eb; }
        .upload-btn:disabled { background: var(--border); cursor: not-allowed; }
        .file-info { color: var(--text-dim); margin-top: 12px; font-size: 13px; }

        /* Progress */
        .progress-section { display: none; margin-bottom: 30px; }
        .progress-bar { background: var(--surface2); border-radius: 8px; overflow: hidden; height: 6px; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--purple)); border-radius: 8px; transition: width 0.5s ease; }
        .progress-step { color: var(--text-dim); font-size: 13px; padding: 4px 0; }
        .progress-step.active { color: var(--blue); }
        .progress-step.done { color: var(--green); }

        /* Results */
        .results-section { display: none; }

        /* Risk Score Card */
        .risk-card { background: var(--surface); border-radius: 16px; padding: 30px; margin-bottom: 24px; display: flex; align-items: center; gap: 30px; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; flex-shrink: 0; }
        .score-circle .number { font-size: 36px; font-weight: 800; line-height: 1; }
        .score-circle .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
        .risk-LOW .score-circle { background: rgba(34, 197, 94, 0.15); border: 3px solid var(--green); color: var(--green); }
        .risk-MODERATE .score-circle { background: rgba(59, 130, 246, 0.15); border: 3px solid var(--blue); color: var(--blue); }
        .risk-ELEVATED .score-circle { background: rgba(245, 158, 11, 0.15); border: 3px solid var(--amber); color: var(--amber); }
        .risk-HIGH .score-circle { background: rgba(249, 115, 22, 0.15); border: 3px solid var(--orange); color: var(--orange); }
        .risk-CRITICAL .score-circle { background: rgba(239, 68, 68, 0.15); border: 3px solid var(--red); color: var(--red); }
        .risk-details h2 { font-size: 22px; margin-bottom: 6px; }
        .risk-details .desc { color: var(--text-dim); font-size: 14px; line-height: 1.5; }
        .risk-stats { display: flex; gap: 20px; margin-top: 12px; }
        .stat { background: var(--surface2); padding: 8px 14px; border-radius: 8px; font-size: 13px; }
        .stat strong { color: var(--text); }

        /* Severity Badges */
        .sev-CRITICAL { background: rgba(239,68,68,0.15); color: var(--red); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .sev-HIGH { background: rgba(249,115,22,0.15); color: var(--orange); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .sev-MEDIUM { background: rgba(245,158,11,0.15); color: var(--amber); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .sev-LOW { background: rgba(59,130,246,0.15); color: var(--blue); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }

        /* Category Cards */
        .categories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .cat-card { background: var(--surface); border-radius: 12px; padding: 18px; border-left: 4px solid var(--border); }
        .cat-card.triggered { border-left-color: var(--orange); }
        .cat-name { font-weight: 600; font-size: 14px; margin-bottom: 6px; }
        .cat-score-bar { background: var(--surface2); border-radius: 4px; height: 4px; margin: 8px 0; }
        .cat-score-fill { height: 100%; border-radius: 4px; }
        .cat-info { font-size: 12px; color: var(--text-dim); display: flex; justify-content: space-between; }

        /* Flags Table */
        .flags-section { background: var(--surface); border-radius: 12px; overflow: hidden; margin-bottom: 24px; }
        .flags-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 20px; border-bottom: 1px solid var(--border); }
        .flags-header h3 { font-size: 16px; }
        .filter-btns { display: flex; gap: 6px; }
        .filter-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .filter-btn.active { background: var(--blue); border-color: var(--blue); color: white; }
        .flag-row { display: grid; grid-template-columns: 40px 1fr 100px 80px 60px; gap: 12px; padding: 12px 20px; border-bottom: 1px solid var(--border); align-items: center; font-size: 13px; }
        .flag-row:last-child { border-bottom: none; }
        .flag-row.triggered { background: rgba(249, 115, 22, 0.03); }
        .flag-num { color: var(--text-dim); font-weight: 600; }
        .flag-name { font-weight: 500; }
        .flag-evidence { color: var(--text-dim); font-size: 12px; margin-top: 3px; max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .flag-row.expanded .flag-evidence { max-height: 200px; }
        .flag-row:hover { background: var(--surface2); cursor: pointer; }
        .flag-status { font-weight: 600; }
        .flag-status.on { color: var(--red); }
        .flag-status.off { color: var(--green); }
        .confidence { color: var(--text-dim); }

        /* Pipeline Steps */
        .pipeline-card { background: var(--surface); border-radius: 12px; padding: 18px 20px; margin-bottom: 24px; }
        .pipeline-card h3 { font-size: 16px; margin-bottom: 12px; }
        .step-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; color: var(--text-dim); border-bottom: 1px solid var(--border); }
        .step-row:last-child { border-bottom: none; }
        .step-time { color: var(--green); font-weight: 600; }

        /* Financial Preview */
        .fin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .fin-item { background: var(--surface2); padding: 10px 14px; border-radius: 8px; }
        .fin-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .fin-value { font-size: 18px; font-weight: 700; margin-top: 2px; }

        /* Error */
        .error-card { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px; color: var(--red); margin-bottom: 20px; display: none; }

        @media (max-width: 768px) {
            .risk-card { flex-direction: column; text-align: center; }
            .flag-row { grid-template-columns: 30px 1fr 70px; }
            .flag-row > :nth-child(4), .flag-row > :nth-child(5) { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Red<span>Flag</span> AI</h1>
        <p class="subtitle">Test Pipeline v2.0 â€” {{ flag_count }} Red Flags | Gemini Flash | PDF-native Analysis</p>

        {% if not gemini_ready %}
        <div class="error-card" style="display:block;">GEMINI_API_KEY not set. Export it and restart: <code>export GEMINI_API_KEY=your_key</code></div>
        {% endif %}

        <!-- Upload -->
        <div class="upload-card" id="uploadCard">
            <input type="file" id="fileInput" accept=".pdf">
            <p style="font-size:32px; margin-bottom:12px;">ðŸ“„</p>
            <button class="upload-btn" id="uploadBtn" onclick="document.getElementById('fileInput').click()">
                Select Annual Report PDF
            </button>
            <p class="file-info" id="fileInfo">Drag & drop or click to select. Supports 1-700+ page Indian annual reports.</p>
        </div>

        <!-- Progress -->
        <div class="progress-section" id="progressSection">
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
            <div id="progressSteps"></div>
        </div>

        <!-- Error -->
        <div class="error-card" id="errorCard"></div>

        <!-- Results -->
        <div class="results-section" id="resultsSection">
            <!-- Risk Score -->
            <div class="risk-card" id="riskCard">
                <div class="score-circle">
                    <div class="number" id="riskScore">0</div>
                    <div class="label" id="riskLevel">-</div>
                </div>
                <div class="risk-details">
                    <h2 id="riskTitle">Risk Assessment</h2>
                    <p class="desc" id="riskDesc"></p>
                    <div class="risk-stats" id="riskStats"></div>
                </div>
            </div>

            <!-- Financial Preview -->
            <div class="pipeline-card">
                <h3>Key Financial Metrics (Extracted by Gemini)</h3>
                <div class="fin-grid" id="finGrid"></div>
            </div>

            <!-- Category Breakdown -->
            <h3 style="margin-bottom:12px; font-size:16px;">Category Breakdown</h3>
            <div class="categories-grid" id="categoriesGrid"></div>

            <!-- Flags -->
            <div class="flags-section">
                <div class="flags-header">
                    <h3>All <span id="flagCount">54</span> Red Flags</h3>
                    <div class="filter-btns">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="triggered">Triggered</button>
                        <button class="filter-btn" data-filter="clear">Clear</button>
                    </div>
                </div>
                <div id="flagsList"></div>
            </div>

            <!-- Pipeline Performance -->
            <div class="pipeline-card">
                <h3>Pipeline Performance</h3>
                <div id="pipelineSteps"></div>
            </div>

            <!-- Sections Detected -->
            <div class="pipeline-card">
                <h3>Sections Detected</h3>
                <div id="sectionsInfo"></div>
            </div>
        </div>
    </div>

    <script>
        const uploadCard = document.getElementById('uploadCard');
        const fileInput = document.getElementById('fileInput');
        const progressSection = document.getElementById('progressSection');
        const resultsSection = document.getElementById('resultsSection');
        const errorCard = document.getElementById('errorCard');

        // Drag & drop
        uploadCard.addEventListener('dragover', e => { e.preventDefault(); uploadCard.classList.add('dragging'); });
        uploadCard.addEventListener('dragleave', () => uploadCard.classList.remove('dragging'));
        uploadCard.addEventListener('drop', e => {
            e.preventDefault(); uploadCard.classList.remove('dragging');
            if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; handleFile(); }
        });
        fileInput.addEventListener('change', handleFile);

        const STEPS = [
            'Extracting text from PDF...',
            'Detecting sections (4-layer regex)...',
            'Extracting section texts...',
            'Slicing PDF to relevant pages...',
            'Analyzing with Gemini Flash (3 calls)...',
            'Running 54 red flag checks...',
            'Calculating risk score...',
        ];

        function handleFile() {
            const file = fileInput.files[0];
            if (!file) return;
            document.getElementById('fileInfo').textContent = `${file.name} (${(file.size/1024/1024).toFixed(1)} MB)`;
            analyzeFile(file);
        }

        async function analyzeFile(file) {
            errorCard.style.display = 'none';
            resultsSection.style.display = 'none';
            progressSection.style.display = 'block';

            // Show steps
            const stepsDiv = document.getElementById('progressSteps');
            stepsDiv.innerHTML = STEPS.map((s, i) => `<div class="progress-step" id="step${i}">${s}</div>`).join('');

            let stepIdx = 0;
            const interval = setInterval(() => {
                if (stepIdx < STEPS.length) {
                    if (stepIdx > 0) document.getElementById(`step${stepIdx-1}`).className = 'progress-step done';
                    document.getElementById(`step${stepIdx}`).className = 'progress-step active';
                    document.getElementById('progressFill').style.width = `${((stepIdx+1)/STEPS.length)*100}%`;
                    stepIdx++;
                }
            }, 3000);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const resp = await fetch('/analyze', { method: 'POST', body: formData });
                clearInterval(interval);
                document.getElementById('progressFill').style.width = '100%';
                STEPS.forEach((_, i) => document.getElementById(`step${i}`).className = 'progress-step done');

                const data = await resp.json();
                if (!resp.ok || data.error) {
                    throw new Error(data.error || 'Analysis failed');
                }
                setTimeout(() => { progressSection.style.display = 'none'; renderResults(data); }, 500);
            } catch (err) {
                clearInterval(interval);
                progressSection.style.display = 'none';
                errorCard.textContent = `Error: ${err.message}`;
                errorCard.style.display = 'block';
            }
        }

        function renderResults(data) {
            resultsSection.style.display = 'block';
            const rs = data.risk_score;

            // Risk Card
            const riskCard = document.getElementById('riskCard');
            riskCard.className = `risk-card risk-${rs.risk_level}`;
            document.getElementById('riskScore').textContent = rs.risk_score;
            document.getElementById('riskLevel').textContent = rs.risk_level;
            document.getElementById('riskTitle').textContent = `${data.filename} â€” ${rs.risk_level} Risk`;
            document.getElementById('riskDesc').textContent = rs.risk_description;
            document.getElementById('riskStats').innerHTML = `
                <div class="stat"><strong>${rs.flags_triggered_count}</strong>/${rs.flags_total_count} flags triggered</div>
                <div class="stat">Time: <strong>${data.total_time_seconds}s</strong></div>
                <div class="stat sev-CRITICAL">${rs.flags_by_severity.critical} Critical</div>
                <div class="stat sev-HIGH">${rs.flags_by_severity.high} High</div>
                <div class="stat sev-MEDIUM">${rs.flags_by_severity.medium} Medium</div>
            `;

            // Financial Preview
            const finGrid = document.getElementById('finGrid');
            const fp = data.financial_data_preview || {};
            const finLabels = { revenue: 'Revenue', net_profit: 'Net Profit', cfo: 'CFO', total_debt: 'Total Debt', equity: 'Equity', total_assets: 'Total Assets' };
            finGrid.innerHTML = Object.entries(finLabels).map(([k, label]) => {
                const val = fp[k];
                const display = val != null ? formatNum(val) : 'N/A';
                return `<div class="fin-item"><div class="fin-label">${label}</div><div class="fin-value">${display}</div></div>`;
            }).join('');

            // Categories
            const catGrid = document.getElementById('categoriesGrid');
            const cb = rs.category_breakdown;
            catGrid.innerHTML = Object.entries(cb).map(([name, d]) => {
                const color = d.score > 60 ? 'var(--red)' : d.score > 30 ? 'var(--orange)' : d.score > 10 ? 'var(--amber)' : 'var(--green)';
                return `<div class="cat-card ${d.flags_triggered > 0 ? 'triggered' : ''}">
                    <div class="cat-name">${name}</div>
                    <div class="cat-score-bar"><div class="cat-score-fill" style="width:${Math.min(d.score,100)}%;background:${color}"></div></div>
                    <div class="cat-info"><span>${d.flags_triggered}/${d.flags_total} triggered</span><span style="color:${color};font-weight:700">${d.score}/100</span></div>
                </div>`;
            }).join('');

            // Flags
            const flagsList = document.getElementById('flagsList');
            document.getElementById('flagCount').textContent = data.flags.length;
            renderFlags(data.flags, 'all');

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderFlags(data.flags, btn.dataset.filter);
                });
            });

            // Pipeline Steps
            const stepsDiv = document.getElementById('pipelineSteps');
            const ps = data.pipeline_steps;
            const stepNames = {
                '1_text_extraction': `Text Extraction (${ps['1_text_extraction']?.total_pages || '?'} pages)`,
                '2_section_detection': `Section Detection (${ps['2_section_detection']?.sections_found?.length || '?'} found)`,
                '3_section_texts': 'Section Text Extraction',
                '4_pdf_slicing': `PDF Slicing (${ps['4_pdf_slicing']?.original_pages || '?'} â†’ ${ps['4_pdf_slicing']?.sliced_pages || '?'} pages)`,
                '5_gemini_analysis': `Gemini Flash Analysis (${ps['5_gemini_analysis']?.model || '?'})`,
                '6_red_flags': `Red Flag Checks (${ps['6_red_flags']?.triggered || 0} triggered)`,
                '7_risk_score': 'Risk Score Calculation',
            };
            stepsDiv.innerHTML = Object.entries(stepNames).map(([k, name]) => {
                const t = ps[k]?.time_seconds ?? '-';
                return `<div class="step-row"><span>${name}</span><span class="step-time">${t}s</span></div>`;
            }).join('');

            // Sections
            const secDiv = document.getElementById('sectionsInfo');
            const secs = data.sections_detected || {};
            secDiv.innerHTML = Object.entries(secs).map(([name, range]) =>
                `<div class="step-row"><span>${name}</span><span>Pages ${range.start}-${range.end}</span></div>`
            ).join('') || '<div class="step-row"><span>No sections detected</span></div>';
        }

        function renderFlags(flags, filter) {
            const list = document.getElementById('flagsList');
            let filtered = flags;
            if (filter === 'triggered') filtered = flags.filter(f => f.is_triggered);
            if (filter === 'clear') filtered = flags.filter(f => !f.is_triggered);
            list.innerHTML = filtered.map(f => `
                <div class="flag-row ${f.is_triggered ? 'triggered' : ''}" onclick="this.classList.toggle('expanded')">
                    <div class="flag-num">#${f.flag_number}</div>
                    <div>
                        <div class="flag-name">${f.flag_name}</div>
                        <div class="flag-evidence">${f.evidence || ''}</div>
                    </div>
                    <div><span class="sev-${f.severity}">${f.severity}</span></div>
                    <div class="flag-status ${f.is_triggered ? 'on' : 'off'}">${f.is_triggered ? 'TRIGGERED' : 'CLEAR'}</div>
                    <div class="confidence">${f.is_triggered ? f.confidence + '%' : ''}</div>
                </div>
            `).join('');
        }

        function formatNum(n) {
            if (n == null) return 'N/A';
            n = Number(n);
            if (Math.abs(n) >= 10000000) return (n/10000000).toFixed(1) + ' Cr';
            if (Math.abs(n) >= 100000) return (n/100000).toFixed(1) + ' L';
            if (Math.abs(n) >= 1000) return (n/1000).toFixed(1) + 'K';
            return n.toFixed(0);
        }
    </script>
</body>
</html>
